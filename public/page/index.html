<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <link rel="stylesheet" href="/public/css/index.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.7.2/dist/css/uikit.min.css" />
  </head>
  <body>
    <div id="sector01">
      <div id="box-top">
        <button id="nick_name" class="button"></button>
        <button id="button-change" class="button">닉네임 변경</button>
        <button id="box-count" class="button"></button>
        <div id="box-title"></div>
      </div>
      <div id="box-msg">
        <ul id="messages"></ul>
      </div>
      <div id="box-send">
        <form id="form-msg" action="">
          <input id="input-msg" autocomplete="off" />
          <button id="send-button">Send</button>
        </form>
      </div>
    </div>
    <div id="sector02">
      <div id="navigator" style="padding-left: 0vw; padding-top: 0px;">
        <nav class="uk-navbar-container" uk-navbar id="navbar">
          <div class="uk-navbar-left">
              <ul class="uk-navbar-nav">
                  <li class="uk-active"><a href="#" style="color: white;">메뉴</a></li>
                  <li>
                      <a href="#">Parent</a>
                      <div class="uk-navbar-dropdown">
                          <ul class="uk-nav uk-navbar-dropdown-nav">
                              <li class="uk-active"><a href="#">Active</a></li>
                              <li><a href="#">Item1</a></li>
                              <li class="uk-nav-header">Header</li>
                              <li><a href="#">Item2</a></li>
                              <li><a href="#">Item3</a></li>
                              <li class="uk-nav-divider"></li>
                              <li><a href="#">Item4</a></li>
                          </ul>
                      </div>
                  </li>
                  <li><a href="#">Item</a>
                  </li>
              </ul>
          </div>
        </nav>
      </div>
      <div id="bar-top">
        <form id="form-login" class="form-top">
          아이디 :
          <input id="input-id" type="text" autocomplete="off">
          비밀번호 :
          <input id="input-password" type="password" autocomplete="off">
          <button id="button-login" class="button" type="submit"">로그인</button>
          <button id="button-create-account" class="button" type="button"">회원가입</button>
        </form>
        <form id="form-logout" class="form-top" style="display: none;">
            <div id="form-comment" style="float: left; margin: 2.5px 10px 5px 0px;">
              안녕하세요 어쩍ㄵ쩌거구 님!
            </div>
          <button id="button-logout" class="button" type="submit">로그아웃</button>
        </form>
      </div>
      <!--  -->
      <div id="content-box">
        <div class="uk-child-width-expand@s uk-text-center uk-margin-small-bottom" uk-grid>
          <div id="daily-index-box" class="uk-card uk-card-default uk-card-large uk-card-body">
            <h3 class="uk-card-title">Large</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
          </div>
          <div id="daily-index-box" class="uk-card uk-card-default uk-card-large uk-card-body">
            <h3 class="uk-card-title">Large</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.</p>
          </div>
        </div>
        <div class="uk-margin-small" uk-slideshow="min-height: 450; animation: slide; autoplay: true; autoplay-interval: 4000; pause-on-hover: true;">
          <ul class="uk-slideshow-items">
              <li>
                <article class="uk-article">
                  <h1 class="uk-article-title"><a class="uk-link-reset" href="">Heading</a></h1>
                  <p class="uk-article-meta">Written by <a href="#">Super User</a> on 12 April 2012. Posted in <a href="#">Blog</a></p>
                  <p class="uk-text-lead">Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip.</p>
                  <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.</p>
                  <div class="uk-grid-small uk-child-width-auto" uk-grid>
                      <div>
                          <a class="uk-button uk-button-text" href="#">Read more</a>
                      </div>
                  </div>
                </article>
              </li>
              <li>
                <div class="uk-section uk-section-large uk-section-secondary">
                  <div class="uk-container">
                      <h3>Section Large</h3>
                      <div class="uk-grid-match uk-child-width-1-3@m" uk-grid>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                      </div>
                  </div>
                </div>
              </li>
          </ul>
          <ul class="uk-slideshow-nav uk-dotnav uk-flex-center uk-margin"></ul>
        </div>
        <div class="uk-margin-small" uk-slideshow="min-height: 450; animation: slide; autoplay: true; autoplay-interval: 4000; pause-on-hover: true;">
          <ul class="uk-slideshow-items">
              <li>
                <div class="uk-section uk-section-large uk-section-secondary">
                  <div class="uk-container">
                      <h3>Section Large</h3>
                      <div class="uk-grid-match uk-child-width-1-3@m" uk-grid>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                      </div>
                  </div>
                </div>
              </li>
              <li>
                <div class="uk-section uk-section-large uk-section-secondary">
                  <div class="uk-container">
                      <h3>Section Large</h3>
                      <div class="uk-grid-match uk-child-width-1-3@m" uk-grid>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                          <div>
                              <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor.</p>
                          </div>
                      </div>
                  </div>
                </div>
              </li>
          </ul>
          <ul class="uk-slideshow-nav uk-dotnav uk-flex-center uk-margin"></ul>
        </div>
      </div>
      <!--  -->
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/uikit@3.7.2/dist/js/uikit.min.js"></script>
  <script src="/public/js/reference.js"></script>
  <script>
    const socket = io('http://localhost:3000');

    // get ip adress
    let ip_address = "";
    function getIp(){
      return new Promise((resolve, reject) => {
        $.getJSON('https://ipapi.co/json/', (data) => {
          resolve(data.ip);
        });
      });
    };

    function timer(sec){
      setTimeout((sec) => {
        console.log("time out!");
      }, 1000 * sec);
    }
    
    let setNickname = (nick_name) => {
      document.getElementById('nick_name').textContent = nick_name;
      titleBox.innerHTML = `안녕하세요 <b>${nick_name}</b> 님`;      
    };

    let getUsername = () => {
      var exp = /개미/;
      let nick_name = prompt('사용할 별명을 입력해주세요. (개미는 사용 불가합니다) (8자리)');
      if(nick_name) {
        if(!exp.test(nick_name)){
          socket.emit(CHECK_NICKNAME, nick_name, (unique) => {
            if(unique){
              console.log("입력한 별명 :", nick_name);
              socket.emit(SET_NICKNAME, nick_name);
              alert(nick_name + ' 으로 설정되었습니다.');
              setNickname(nick_name);
            }
            else{
              alert(nick_name + '은 이미 존재하는 별명입니다.');
              changeButton.click();
            }
          });
        }
        else{
          alert('개미는 변경할 수 없는 별명입니다.');
        }
      }
      else{
        alert('별명을 입력하세요.');
      }
    };

    let appendMsg = (msg, align) => {
      let item = document.createElement('li');
      if(align == 'right')
      {
        item.style.textAlign="right";
      }
      item.textContent = msg;
      messages.appendChild(item);
      msgBox.scrollTo(0, msgBox.scrollHeight);
    };

    msgForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if(inputMsg.value){
        socket.emit(CHAT_MSG, inputMsg.value);
        appendMsg(inputMsg.value, 'right');
        inputMsg.value = ''; //input value reset
      }
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if(inputId.value && inputPassword.value){
        let account = {id : inputId.value, password : inputPassword.value};
        socket.emit(CHECK_ACCOUNT, account, (nick_name) => {
            if(nick_name){
              alert(nick_name + ' 님 환영합니다.');
              setNickname(nick_name);
              socket.emit(SET_NICKNAME, nick_name);
              loginForm.style.display='none';
              logoutForm.style.display='block';
            }
            else{
              alert('로그인 실패');
            }
          });
        inputId.value = '';
        inputPassword.value = '';
      }
    });
    
    changeButton.addEventListener('click', (e) => {
      e.preventDefault();
      // getUserName();
      var exp = /개미/;
      let nick_name = prompt('사용할 별명을 입력해주세요. (개미는 사용할 수 없는 단어입니다) (8자리)');
      if(nick_name) {
        if(!exp.test(nick_name)){
          socket.emit(CHECK_NICKNAME, nick_name, (unique) => {
            if(unique){
              console.log("입력한 별명 :", nick_name);
              socket.emit(SET_NICKNAME, nick_name);
              alert(nick_name + ' 으로 설정되었습니다.');
              setNickname(nick_name);
            }
            else{
              alert(nick_name + '은 이미 존재하는 별명입니다.');
              changeButton.click();
            }
          });
        }
        else{
          alert('개미는 사용할 수 없는 단어입니다');
        }
      }
      else{
        alert('별명을 입력하세요.');
      }
    });
    
    accountPage.addEventListener('click', (e) =>{
      e.preventDefault();

      socket.emit(CHECK_IP, ip_address, (unique) => {
        if(unique){
          location.href = '/account';
        }
        else{
          alert('접속자 ip는 이미 계정이 있습니다')
        }
      });
      location.href = '/account';
    });
    
    logoutButton.addEventListener('click', (e) => {
      e.preventDefault();
      location.href = '/';
    });

    var first_set = false;
    socket.on(CONNECTED, (count) => {
      countBox.textContent = "접속자 수 : " + count;
      if(!first_set){
        document.getElementById('nick_name').textContent = '개미';
        titleBox.innerHTML = `안녕하세요 <b>개미</b> 님`;
        appendMsg('채팅방에 오신 것을 환영합니다! (욕설/도배 ip 밴입니다.)', null);
        first_set = true;
      }
    });
    
    socket.on(UPDATE_CLIENTNUM, (count) => {
      countBox.textContent = "접속자 수 : " + count;
    });
    
    socket.on(CHAT_MSG, (msg) => {
      appendMsg(msg, 'left');
    });

    socket.on(GET_ALERT, (msg) => {
      alert(msg);
    });
  
  </script>
</html>