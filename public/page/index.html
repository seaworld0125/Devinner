<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <!-- <link rel="stylesheet" href="../css/index.css"> -->
    <style>
      html {
        height: 100vh;
        overflow: hidden;
      }
      body { 
        height: 100%;
        margin: 0px; 
        z-index: -1000; 
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
      }

      #sector01 {
        width: 400px;
        height: 100%;
        position: fixed; top: 0; right: 0;
        background-color: rgb(33, 33, 33);
      } 
      #sector02 {
        width: calc(100% - 400px);
        min-width: 592px;
        height: 100%;
        position: fixed; top: 0; left: 0;
        background-color: rgb(26, 25, 25);
        overflow-x: scroll;
      }
      #navigator{
        height: 59.6px;
        width: calc(100% - 400px);
        position: fixed; top: 0; left: 0;
      }

      #bar-top{
        height: 33px;
        width: calc(100% - 400px);
        position: fixed; top: 60.4px; left: 0;
        text-align: left;
        border-bottom-color: rgba(255, 255, 255, 0.486);
        border-bottom-width: 0.1px;
        border-bottom-style: solid;
      }
      #bar-top > .form-top{
        height: 33px;
        padding-left: 1.5vw;
        font-size: medium;
        color: honeydew;
      }
      #bar-top .button{
        background: #333; 
        border: none; 
        padding: 0 1rem; 
        margin: 0.25rem; 
        border-radius: 3px; 
        outline: none; 
        color: #fff; 
        width: 8vw; 
        min-width: 85.5px; 
        height: 1.2rem;
        background-color: blueviolet;
      }
      #box-top{
        width: 400px;
        background-color: blueviolet;
        position: fixed; 
        top: 0; 
        right: 0;
      }
      #box-msg{
        width: 400px;
        height: calc(100% - (60px + 48px));
        position: fixed; 
        top: 60px; 
        right: 0;
        overflow: scroll;
      }
      #box-send{
        width: 400px;
        height: 3rem;
        position: fixed; 
        bottom: 0; 
        right: 0;
      } 
      #box-title{
        border: none; 
        padding: 0.5rem 1rem;
        margin: 0; 
        outline: none; 
        font-size: medium;
      }

      #input-msg { 
        border: none; 
        padding: 0 1rem; 
        border-radius: 2rem; 
        margin: 0.25rem; 
        width: 80%; 
      }
      #input-msg:focus { 
        outline: none; 
      }
      #input-id{
        border: none; 
        padding: 0 1rem; 
        border-radius: 2rem; 
        margin: 0.25rem; 
        width: 8vw; 
        height: 1.2rem;
      }
      #input-id:focus { 
        outline: none; 
      }
      #input-password{
        border: none; 
        padding: 0 1rem; 
        border-radius: 2rem; 
        margin: 0.25rem; 
        width: 8vw; 
        height: 1.2rem;
      }
      #input-password:focus {
        outline: none; 
      }

      .button{
        background: #333; 
        border: none; 
        padding: 0px 7px; 
        margin-left: 7px; 
        border-radius: 3px; 
        outline: none; 
        color: #fff; 
        font-size: small;
        height: 20px;
      }
      #form-msg {
        padding: 0.25rem; 
        display: flex; 
        height: 3rem; 
        box-sizing: border-box; 
        backdrop-filter: blur(10px);
      }
      #form-msg > button { 
        background: #333; 
        border: none; 
        padding: 0 1rem; 
        margin: 0.25rem; 
        border-radius: 3px; 
        outline: none; 
        color: #fff; 
        width: 20%;
      }

      #messages { 
        list-style-type: none; 
        margin: 0; 
        padding: 0;
      }
      #messages > li { 
        color: rgb(189, 185, 185); 
        font-size: medium;
        padding: 0.5rem 1rem; 
      }
      @media (max-width : 992px){
        #sector02{
          display: none;
        }
        #sector01, #box-top, #box-msg, #box-send{
          width: 100%;
        }
      }
    </style>
  </head>
  <body>
    <div id="sector01">
      <div id="box-top">
        <button id="nick_name" class="button"></button>
        <button id="button-change" class="button">닉네임 변경</button>
        <button id="box-count" class="button"></button>
        <div id="box-title"></div>
      </div>
      <div id="box-msg">
        <ul id="messages"></ul>
      </div>
      <div id="box-send">
        <form id="form-msg" action="">
          <input id="input-msg" autocomplete="off" />
          <button id="send-button" style="background-color: blueviolet;">Send</button>
        </form>
      </div>
    </div>
    <div id="sector02">
      <div id="navigator"></div>
      <div id="bar-top">
        <form id="form-login" class="form-top">
          아이디 :
          <input id="input-id" type="text" autocomplete="off">
          비밀번호 :
          <input id="input-password" type="password" autocomplete="off">
          <button id="button-login" class="button" type="submit">로그인</button>
          <button id="button-create-account" class="button" type="button">회원가입</button>
        </form>
        <form id="form-logout" class="form-top" style="display: none;">
            <div id="form-comment" style="float: left; margin: 2.5px 10px 5px 0px;">
              안녕하세요 어쩍ㄵ쩌거구 님!
            </div>
          <button id="button-logout" class="button" type="submit">로그아웃</button>
        </form>
      </div>
    </div>
  </body>
  <script src="/socket.io/socket.io.js"></script>
  <script src="https://code.jquery.com/jquery-latest.min.js"></script>
  <script>
    const socket = io('http://localhost:3000');
    
    // sector01 under area
    const msgForm = document.getElementById('form-msg');
    const messages = document.getElementById('messages');
    const inputMsg = document.getElementById('input-msg');
    const msgBox = document.getElementById('box-msg');
    
    // sector01 top area 
    const titleBox = document.getElementById('box-title');
    const countBox = document.getElementById('box-count');
    const changeButton = document.getElementById('button-change');
    
    // sector02 login area 
    const loginForm = document.getElementById('form-login');
    const buttonLogin = document.getElementById('button-login');
    const inputId = document.getElementById('input-id');
    const inputPassword = document.getElementById('input-password');
    const accountPage = document.getElementById('button-create-account');
    
    // sector already login area 
    const logoutForm = document.getElementById('form-logout');
    const commentForm = document.getElementById('form-comment');
    const logoutButton = document.getElementById('button-logout');
    
    // socket.io Event naming
    const CONNECTED = 'connected';
    const UPDATE_CLIENTNUM = 'update-clientNum';
    const CHAT_MSG = 'chat-msg';
    const CHECK_NICKNAME = 'check-nickname';
    const CHECK_ACCOUNT = 'check-account';
    const CHECK_IP = 'check-ip';
    const SET_NICKNAME = 'set-nickname';
    const CHECK_BAN_LIST = 'check-ban-list';
    const GET_ALERT = 'get-alert';

    // get ip adress
    let ip_address = "";
    function getIp(){
      return new Promise((resolve, reject) => {
        $.getJSON('https://ipapi.co/json/', (data) => {
          resolve(data.ip);
        });
      });
    };
    
    let setNickname = (nick_name) => {
      document.getElementById('nick_name').textContent = nick_name;
      titleBox.innerHTML = `안녕하세요 <b>${nick_name}</b> 님`;      
    };

    let getUsername = () => {
      var exp = /개미/;
      let nick_name = prompt('사용할 별명을 입력해주세요. (개미는 사용 불가합니다) (8자리)');
      if(nick_name) {
        if(!exp.test(nick_name)){
          socket.emit(CHECK_NICKNAME, nick_name, (unique) => {
            if(unique){
              console.log("입력한 별명 :", nick_name);
              socket.emit(SET_NICKNAME, nick_name);
              alert(nick_name + ' 으로 설정되었습니다.');
              setNickname(nick_name);
            }
            else{
              alert(nick_name + '은 이미 존재하는 별명입니다.');
              changeButton.click();
            }
          });
        }
        else{
          alert('개미는 변경할 수 없는 별명입니다.');
        }
      }
      else{
        alert('별명을 입력하세요.');
      }
    };

    let appendMsg = (msg, align) => {
      let item = document.createElement('li');
      if(align == 'right')
      {
        item.style.textAlign="right";
      }
      item.textContent = msg;
      messages.appendChild(item);
      msgBox.scrollTo(0, msgBox.scrollHeight);
    };

    msgForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if(inputMsg.value){
        socket.emit(CHAT_MSG, inputMsg.value);
        appendMsg(inputMsg.value, 'right');
        inputMsg.value = ''; //input value reset
      }
    });

    loginForm.addEventListener('submit', (e) => {
      e.preventDefault();
      if(inputId.value && inputPassword.value){
        let account = {id : inputId.value, password : inputPassword.value};
        socket.emit(CHECK_ACCOUNT, account, (nick_name) => {
            if(nick_name){
              alert(nick_name + ' 님 환영합니다.');
              setNickname(nick_name);
              socket.emit(SET_NICKNAME, nick_name);
              loginForm.style.display='none';
              logoutForm.style.display='block';
            }
            else{
              alert('로그인 실패');
            }
          });
        inputId.value = '';
        inputPassword.value = '';
      }
    });
    
    changeButton.addEventListener('click', (e) => {
      e.preventDefault();
      // getUserName();
      var exp = /개미/;
      let nick_name = prompt('사용할 별명을 입력해주세요. (개미는 사용할 수 없는 단어입니다) (8자리)');
      if(nick_name) {
        if(!exp.test(nick_name)){
          socket.emit(CHECK_NICKNAME, nick_name, (unique) => {
            if(unique){
              console.log("입력한 별명 :", nick_name);
              socket.emit(SET_NICKNAME, nick_name);
              alert(nick_name + ' 으로 설정되었습니다.');
              setNickname(nick_name);
            }
            else{
              alert(nick_name + '은 이미 존재하는 별명입니다.');
              changeButton.click();
            }
          });
        }
        else{
          alert('개미는 사용할 수 없는 단어입니다');
        }
      }
      else{
        alert('별명을 입력하세요.');
      }
    });
    
    accountPage.addEventListener('click', (e) =>{
      e.preventDefault();

      socket.emit(CHECK_IP, ip_address, (unique) => {
        if(unique){
          location.href = '/account';
        }
        else{
          alert('접속자 ip는 이미 계정이 있습니다')
        }
      });
      location.href = '/account';
    });
    
    logoutButton.addEventListener('click', (e) => {
      e.preventDefault();
      location.href = '/';
    });

    var first_set = false;
    socket.on(CONNECTED, (count) => {
      countBox.textContent = "접속자 수 : " + count;
      if(!first_set){
        getIp().then((ip) => {
          console.log('ip :' + ip);
          socket.emit(CHECK_BAN_LIST, ip);
          ip_address = ip;
        });
        document.getElementById('nick_name').textContent = '개미';
        titleBox.innerHTML = `안녕하세요 <b>개미</b> 님`;
        appendMsg('채팅방에 오신 것을 환영합니다! (욕설/도배 자동 ip 밴입니다.)', null);
        first_set = true;
      }
    });
    
    socket.on(UPDATE_CLIENTNUM, (count) => {
      countBox.textContent = "접속자 수 : " + count;
    });
    
    socket.on(CHAT_MSG, (msg) => {
      appendMsg(msg, 'left');
    });

    socket.on(GET_ALERT, (msg) => {
      alert(msg);
    });
  
  </script>
</html>